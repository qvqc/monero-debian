#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk

DH_OPTIONS = -O--buildsystem=cmake

# detect if build targets experimental suite (or is a draft)
DEB_SUITE_EXP = $(filter experimental% UNRELEASED,$(DEB_DISTRIBUTION))

#testsuite needs writable $HOME
FAKEHOME = $(CURDIR)/debian/fakehome

# skip tests requiring network
export GTEST_FILTER = address_from_url.*:dns_resolver.*

override_dh_auto_configure:
	dh_auto_configure -- -DARCH=default -DNO_AES=ON -DBUILD_TESTS=ON

override_dh_auto_test:
	HOME="${FAKEHOME}" \
		dh_auto_test -- ARGS+="--output-on-failure -E core_tests" \
		$(if $(DEB_SUITE_EXP),|| true)

override_dh_install:
	dh_install

override_dh_missing:
	dh_missing --fail-missing

override_dh_auto_clean:
	rm -rf "$(FAKEHOME)"
	dh_auto_clean

%:
	dh $@ --parallel $(DH_OPTIONS:-O%=%)
